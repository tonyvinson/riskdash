FROM python:3.13-bookworm

ENV POETRY_VERSION=1.8.2 \
    GOLANG_VERSION=1.22.3 \
    PATH="/usr/local/go/bin:/root/.local/bin:/root/.poetry/bin:$PATH"

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && \
    apt-get dist-upgrade -y && \
    apt-get install -y --no-install-recommends \
        curl \
        build-essential \
        gcc \
        git \
        libffi-dev \
        libpq-dev \
        libssl-dev \
        make \
        postgresql-client \
        python3-dev \
        bash \
        ca-certificates \
        gnupg && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Install Go
RUN curl -fsSL "https://go.dev/dl/go${GOLANG_VERSION}.linux-amd64.tar.gz" -o go.tar.gz && \
    tar -C /usr/local -xzf go.tar.gz && rm go.tar.gz

# Install Poetry
RUN curl -sSL -o install-poetry.py https://install.python-poetry.org && \
    python3 install-poetry.py && \
    poetry config virtualenvs.in-project false && \
    rm install-poetry.py

WORKDIR /app

# Copy pyproject files and install dependencies
COPY pyproject.toml poetry.lock* /app/

# Optional workaround: install problematic packages ahead of time
RUN pip install --upgrade pip && \
    pip install --no-use-pep517 "pyclamd==0.4.0" || true

RUN poetry install --no-root --no-interaction --no-ansi

COPY . /app

RUN apt-get purge -y build-essential gcc make && \
    apt-get autoremove -y && \
    rm -rf /root/.cache /var/lib/apt/lists/*
